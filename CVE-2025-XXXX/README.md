# 🐚 CloudPanel PHP-FPM Misconfiguration: From Curiosity to Root

> A real-world privilege escalation journey through misconfigured FastCGI in CloudPanel

---

## 📘 Introduction

This is a story of curiosity — how a simple intention to learn how user isolation works in CloudPanel led to a full **local privilege escalation to root** via a chain of PHP-FPM and sudo misconfigurations.

---

## 🧠 Motivation

Initially, I installed the latest version of **CloudPanel**, just to understand how it separates websites and users.

I noticed that for each website:

- If the document root was `/home/eagle/`, it ran under user `eagle`
- If the document root was `/home/aizat/`, it used user `aizat`

This made me curious:

> *How does Nginx map these users? Is it using any special modules or custom directives?*

So, I started digging into the config files.

---

## 🔍 Nginx & FastCGI Observations

I began by exploring the Nginx configuration under:

```
/home/clp/services/nginx/sites-enabled/cloudpanel.conf
```

In one of the configs, I found:

```nginx
fastcgi_pass 127.0.0.1:8787;
```

At first, I expected separate FastCGI pools per user — but nope. I found **only one default pool**, reused for all sites.

That led me to inspect PHP-FPM’s pool configuration at:

```
/etc/php/*/fpm/pool.d/default.conf
```

Here’s what I discovered:

- The pool was running under a user named `clp`
- No `listen.owner`, `listen.group`, or `listen.mode` were set
- There were **no directory restrictions**, such as `open_basedir`

This meant that **any local user could potentially connect to the FastCGI socket or port**, and execute arbitrary PHP scripts — as the `clp` user.

---

## 🧪 The First Exploit Attempt (with `cgi-fcgi`)

I wanted to test my theory, so I dropped a file:

```php
<?php system('id'); ?>
```

Then used the `cgi-fcgi` tool to send a manual request with `SCRIPT_FILENAME=/tmp/exploit.php`.

It worked.

The output confirmed that the script was executed under the `clp` user.

---

## ⚠️ But Who is `clp`?

Digging further, I realized something dangerous:

> `clp` is the main system user used by CloudPanel — and it has `sudo` access **without a password**.

```bash
clp ALL=(ALL) NOPASSWD:ALL
```

So I tested a new payload that would `sudo chown` and `chmod +s` a compiled SUID binary.

Then executed that binary to spawn a root shell.

And just like that... I had root access.

---

## 🛠 A Better Exploit: Pure Python (No `cgi-fcgi`)

When I tested this on a fresh Ubuntu install, I realized:

> `cgi-fcgi` isn't installed by default.

I didn’t want to rely on any external tools, so I asked GPT to help me re-implement a FastCGI client in **pure Python**.

GPT generated a working base, and I integrated it with my exploit.

Now the entire flow was handled by a **single Python script** — no `cgi-fcgi` required.

It handled:

- Writing the PHP payload
- Compiling the SUID shell binary
- Sending the crafted FastCGI request
- Triggering the privilege escalation
- Launching a root shell

---

## 💣 Impact Summary

Using this misconfiguration, an attacker with basic local access (or even a low-privileged web user) could:

- Execute arbitrary PHP code as `clp`
- Leverage `sudo` to modify a SUID binary
- Escalate to full root access

All because of:

- Shared PHP-FPM pool with world-accessible listener
- No access control (no `listen.mode`, `listen.owner`)
- Overpowered `clp` user with passwordless `sudo`

---

## 🔐 Suggested Fixes

To prevent this:

- Use strict `listen.owner`, `listen.group`, and `listen.mode` in pool config
- Create **separate PHP-FPM pools per site/user**
- Remove unnecessary `sudo` access for service accounts like `clp`
- Enable `open_basedir` and consider `chroot` or similar sandboxing
- Never expose FastCGI sockets or ports globally

---

## 🧾 Conclusion

What started as a learning exercise — trying to understand how CloudPanel separates users — led me to discover a serious privilege escalation flaw.

It was a perfect storm of:

- Misconfigured PHP-FPM
- Over-permissive user privileges
- And a little bit of curiosity

In the end, it reminded me:

> Sometimes the most dangerous bugs aren’t in code — they’re in the config files.

---

## ✉️ Notes

- I already submit as CVE still waiting for the CVE ID.
- Exploit script will be published after new patch has been made by CloudPanel team.
- Tested on latest CloudPanel (at time of writing) on Ubuntu/Debian.
